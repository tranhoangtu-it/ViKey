name: Build macOS Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
        key: macos-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: macos-cargo-

    - name: Build Rust core (static lib)
      working-directory: core
      run: cargo build --release --target aarch64-apple-darwin

    - name: Copy library to app-macos
      run: |
        mkdir -p app-macos/ViKey/lib
        cp core/target/aarch64-apple-darwin/release/libvikey_core.a app-macos/ViKey/lib/

    - name: Build Swift app
      working-directory: app-macos
      run: |
        mkdir -p build/ViKey.app/Contents/MacOS
        mkdir -p build/ViKey.app/Contents/Resources

        swiftc \
          -O \
          -import-objc-header ViKey/Sources/ViKey-Bridging-Header.h \
          -L ViKey/lib \
          -lvikey_core \
          -framework Foundation \
          -framework AppKit \
          -framework InputMethodKit \
          -target arm64-apple-macos12.0 \
          -o build/ViKey.app/Contents/MacOS/ViKey \
          ViKey/Sources/main.swift \
          ViKey/Sources/RustBridge.swift \
          ViKey/Sources/ViKeyInputController.swift \
          ViKey/Sources/Settings.swift

        cp ViKey/Resources/Info.plist build/ViKey.app/Contents/
        cp ViKey/Resources/AppIcon.icns build/ViKey.app/Contents/Resources/ 2>/dev/null || true
        cp ViKey/Resources/ViKey.tiff build/ViKey.app/Contents/Resources/ 2>/dev/null || true

    - name: Code sign
      run: codesign --force --sign - app-macos/build/ViKey.app

    - name: Create release package
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        mkdir -p release
        cd app-macos/build
        zip -r "../../release/ViKey-v${VERSION}-macos-arm64.zip" ViKey.app/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ViKey-macOS-arm64
        path: release/ViKey-v*-macos-arm64.zip

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: release/ViKey-v*-macos-arm64.zip
